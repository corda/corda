{"version":3,"file":"event_binder.js","sourceRoot":"","sources":["../../../../../../modules/@angular/compiler/src/view_compiler/event_binder.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {CompileDirectiveMetadata} from '../compile_metadata';\nimport {ListWrapper, StringMapWrapper} from '../facade/collection';\nimport {StringWrapper, isBlank, isPresent} from '../facade/lang';\nimport * as o from '../output/output_ast';\nimport {BoundEventAst, DirectiveAst} from '../template_ast';\n\nimport {CompileBinding} from './compile_binding';\nimport {CompileElement} from './compile_element';\nimport {CompileMethod} from './compile_method';\nimport {EventHandlerVars, ViewProperties} from './constants';\nimport {convertCdStatementToIr} from './expression_converter';\n\nexport class CompileEventListener {\n  private _method: CompileMethod;\n  private _hasComponentHostListener: boolean = false;\n  private _methodName: string;\n  private _eventParam: o.FnParam;\n  private _actionResultExprs: o.Expression[] = [];\n\n  static getOrCreate(\n      compileElement: CompileElement, eventTarget: string, eventName: string,\n      targetEventListeners: CompileEventListener[]): CompileEventListener {\n    var listener = targetEventListeners.find(\n        listener => listener.eventTarget == eventTarget && listener.eventName == eventName);\n    if (isBlank(listener)) {\n      listener = new CompileEventListener(\n          compileElement, eventTarget, eventName, targetEventListeners.length);\n      targetEventListeners.push(listener);\n    }\n    return listener;\n  }\n\n  constructor(\n      public compileElement: CompileElement, public eventTarget: string, public eventName: string,\n      listenerIndex: number) {\n    this._method = new CompileMethod(compileElement.view);\n    this._methodName =\n        `_handle_${santitizeEventName(eventName)}_${compileElement.nodeIndex}_${listenerIndex}`;\n    this._eventParam = new o.FnParam(\n        EventHandlerVars.event.name,\n        o.importType(this.compileElement.view.genConfig.renderTypes.renderEvent));\n  }\n\n  addAction(\n      hostEvent: BoundEventAst, directive: CompileDirectiveMetadata,\n      directiveInstance: o.Expression) {\n    if (isPresent(directive) && directive.isComponent) {\n      this._hasComponentHostListener = true;\n    }\n    this._method.resetDebugInfo(this.compileElement.nodeIndex, hostEvent);\n    var context = isPresent(directiveInstance) ? directiveInstance :\n                                                 this.compileElement.view.componentContext;\n    var actionStmts = convertCdStatementToIr(this.compileElement.view, context, hostEvent.handler);\n    var lastIndex = actionStmts.length - 1;\n    if (lastIndex >= 0) {\n      var lastStatement = actionStmts[lastIndex];\n      var returnExpr = convertStmtIntoExpression(lastStatement);\n      var preventDefaultVar = o.variable(`pd_${this._actionResultExprs.length}`);\n      this._actionResultExprs.push(preventDefaultVar);\n      if (isPresent(returnExpr)) {\n        // Note: We need to cast the result of the method call to dynamic,\n        // as it might be a void method!\n        actionStmts[lastIndex] =\n            preventDefaultVar.set(returnExpr.cast(o.DYNAMIC_TYPE).notIdentical(o.literal(false)))\n                .toDeclStmt(null, [o.StmtModifier.Final]);\n      }\n    }\n    this._method.addStmts(actionStmts);\n  }\n\n  finishMethod() {\n    var markPathToRootStart = this._hasComponentHostListener ?\n        this.compileElement.appElement.prop('componentView') :\n        o.THIS_EXPR;\n    var resultExpr: o.Expression = o.literal(true);\n    this._actionResultExprs.forEach((expr) => { resultExpr = resultExpr.and(expr); });\n    var stmts =\n        (<o.Statement[]>[markPathToRootStart.callMethod('markPathToRootAsCheckOnce', []).toStmt()])\n            .concat(this._method.finish())\n            .concat([new o.ReturnStatement(resultExpr)]);\n    // private is fine here as no child view will reference the event handler...\n    this.compileElement.view.eventHandlerMethods.push(new o.ClassMethod(\n        this._methodName, [this._eventParam], stmts, o.BOOL_TYPE, [o.StmtModifier.Private]));\n  }\n\n  listenToRenderer() {\n    var listenExpr: any /** TODO #9100 */;\n    var eventListener = o.THIS_EXPR.callMethod(\n        'eventHandler',\n        [o.THIS_EXPR.prop(this._methodName).callMethod(o.BuiltinMethod.bind, [o.THIS_EXPR])]);\n    if (isPresent(this.eventTarget)) {\n      listenExpr = ViewProperties.renderer.callMethod(\n          'listenGlobal', [o.literal(this.eventTarget), o.literal(this.eventName), eventListener]);\n    } else {\n      listenExpr = ViewProperties.renderer.callMethod(\n          'listen', [this.compileElement.renderNode, o.literal(this.eventName), eventListener]);\n    }\n    var disposable = o.variable(`disposable_${this.compileElement.view.disposables.length}`);\n    this.compileElement.view.disposables.push(disposable);\n    // private is fine here as no child view will reference the event handler...\n    this.compileElement.view.createMethod.addStmt(\n        disposable.set(listenExpr).toDeclStmt(o.FUNCTION_TYPE, [o.StmtModifier.Private]));\n  }\n\n  listenToDirective(directiveInstance: o.Expression, observablePropName: string) {\n    var subscription = o.variable(`subscription_${this.compileElement.view.subscriptions.length}`);\n    this.compileElement.view.subscriptions.push(subscription);\n    var eventListener = o.THIS_EXPR.callMethod(\n        'eventHandler',\n        [o.THIS_EXPR.prop(this._methodName).callMethod(o.BuiltinMethod.bind, [o.THIS_EXPR])]);\n    this.compileElement.view.createMethod.addStmt(\n        subscription\n            .set(directiveInstance.prop(observablePropName)\n                     .callMethod(o.BuiltinMethod.SubscribeObservable, [eventListener]))\n            .toDeclStmt(null, [o.StmtModifier.Final]));\n  }\n}\n\nexport function collectEventListeners(\n    hostEvents: BoundEventAst[], dirs: DirectiveAst[],\n    compileElement: CompileElement): CompileEventListener[] {\n  var eventListeners: CompileEventListener[] = [];\n  hostEvents.forEach((hostEvent) => {\n    compileElement.view.bindings.push(new CompileBinding(compileElement, hostEvent));\n    var listener = CompileEventListener.getOrCreate(\n        compileElement, hostEvent.target, hostEvent.name, eventListeners);\n    listener.addAction(hostEvent, null, null);\n  });\n  ListWrapper.forEachWithIndex(dirs, (directiveAst, i) => {\n    var directiveInstance = compileElement.directiveInstances[i];\n    directiveAst.hostEvents.forEach((hostEvent) => {\n      compileElement.view.bindings.push(new CompileBinding(compileElement, hostEvent));\n      var listener = CompileEventListener.getOrCreate(\n          compileElement, hostEvent.target, hostEvent.name, eventListeners);\n      listener.addAction(hostEvent, directiveAst.directive, directiveInstance);\n    });\n  });\n  eventListeners.forEach((listener) => listener.finishMethod());\n  return eventListeners;\n}\n\nexport function bindDirectiveOutputs(\n    directiveAst: DirectiveAst, directiveInstance: o.Expression,\n    eventListeners: CompileEventListener[]) {\n  StringMapWrapper.forEach(\n      directiveAst.directive.outputs,\n      (eventName: any /** TODO #9100 */, observablePropName: any /** TODO #9100 */) => {\n        eventListeners.filter(listener => listener.eventName == eventName).forEach((listener) => {\n          listener.listenToDirective(directiveInstance, observablePropName);\n        });\n      });\n}\n\nexport function bindRenderOutputs(eventListeners: CompileEventListener[]) {\n  eventListeners.forEach(listener => listener.listenToRenderer());\n}\n\nfunction convertStmtIntoExpression(stmt: o.Statement): o.Expression {\n  if (stmt instanceof o.ExpressionStatement) {\n    return stmt.expr;\n  } else if (stmt instanceof o.ReturnStatement) {\n    return stmt.value;\n  }\n  return null;\n}\n\nfunction santitizeEventName(name: string): string {\n  return StringWrapper.replaceAll(name, /[^a-zA-Z_]/g, '_');\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}